name: Build tilesets
on:
  workflow_dispatch:
  workflow_call:

jobs:
  setup:
    name: install-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: musl python3 python3-pip libvips42
      - run: pip3 install pyvips

      - name: Clone tileset repo
        uses: actions/checkout@v4
        with:
          repository: I-am-Erk/CDDA-Tilesets
          ref: master
          path: build-tilesets
          fetch-depth: 1

  builds:
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Altica
            artifact: Altica
            tileset_dir: gfx/Altica
            compose_args: --use-all --obsolete-fillers
          - name: ASCII_Overmap
            artifact: ASCII_Overmap
            tileset_dir: gfx/ASCII_Overmap
            compose_args: --use-all
          - name: BrownLikeBears
            artifact: BrownLikeBears
            tileset_dir: gfx/BrownLikeBears
            compose_args: --use-all --obsolete-fillers
          - name: ChibiUltica
            artifact: ChibiUltica
            tileset_dir: gfx/Chibi_Ultica
            compose_args: --use-all
          - name: HollowMoon
            artifact: HollowMoon
            tileset_dir: gfx/HollowMoon
            compose_args: --use-all --obsolete-fillers
          - name: Larwick_Overmap
            artifact: Larwick_Overmap
            tileset_dir: gfx/Larwick_Overmap
            compose_args: --use-all
          - name: MShockXotto+
            artifact: MshockXotto+
            tileset_dir: gfx/MShockXotto+
            compose_args: --use-all
          - name: NeoDays
            artifact: NeoDaysTileset
            tileset_dir: gfx/NeoDays
            compose_args: --use-all
          - name: Retrodays
            artifact: RetroDaysTileset
            tileset_dir: gfx/Retrodays
            compose_args: --use-all
          - name: GiantDays
            artifact: GiantDays
            tileset_dir: gfx/GiantDays
            compose_args: --use-all
          - name: SmashButton_iso
            artifact: SmashButton_iso
            tileset_dir: gfx/HitButton_iso
            compose_args: --use-all
          - name: SurveyorsMap
            artifact: SurveyorsMap
            tileset_dir: gfx/SurveyorsMap
            compose_args: --use-all
          - name: UltimateCataclysm
            artifact: UltimateCataclysm
            tileset_dir: gfx/UltimateCataclysm
            compose_args: --use-all --obsolete-fillers
          - name: Ultica_iso
            artifact: Ultica_iso
            tileset_dir: gfx/Ultica_iso
            compose_args: --use-all
          - name: PenAndPaper
            artifact: PenAndPaper
            tileset_dir: gfx/PenAndPaper
            compose_args: --use-all
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build ${{ matrix.name }}
        run: |
          export SOURCE="build-tilesets/${{ matrix.tileset_dir }}"
          export DEST="${{ matrix.tileset_dir }}"
          python3 ${{ github.workspace }}/tools/gfx_tools/compose.py ${{ matrix.compose_args }} --feedback CONCISE --loglevel INFO --format-json "$SOURCE" "$DEST"

          mv "$SOURCE/tileset.txt" "$DEST/"
          [ -f "$SOURCE/fallback.png"  ] && mv "$SOURCE/fallback.png"  "$DEST/"
          [ -f "$SOURCE/layering.json" ] && mv "$SOURCE/layering.json" "$DEST/"
